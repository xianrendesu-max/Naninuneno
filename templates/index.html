<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Cloud Chrome Elite</title>
    <style>
        :root { --bg: #202124; --toolbar: #35363a; --tab-active: #fff; --accent: #1a73e8; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        .browser { display: flex; flex-direction: column; height: 100%; }

        /* タブバー */
        .tab-bar { display: flex; background: var(--bg); padding: 8px 10px 0; gap: 4px; align-items: flex-end; }
        .tab { background: var(--toolbar); color: white; padding: 8px 15px; border-radius: 8px 8px 0 0; border: none; font-size: 12px; cursor: pointer; min-width: 140px; display: flex; align-items: center; transition: 0.2s; }
        .tab.active { background: var(--tab-active); color: black; font-weight: bold; }
        .tab .close { margin-left: auto; opacity: 0.5; font-size: 14px; }
        .add-btn { color: white; font-size: 20px; padding: 0 10px; cursor: pointer; }

        /* ツールバー */
        .toolbar { background: white; padding: 8px 15px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #ddd; z-index: 10; }
        .address-bar { flex-grow: 1; background: #f1f3f4; border: none; border-radius: 20px; padding: 8px 20px; font-size: 14px; outline: none; }
        .address-bar:focus { background: #fff; box-shadow: 0 0 0 2px var(--accent); }

        /* コンテンツ領域 */
        .viewport-container { flex-grow: 1; position: relative; background: white; }
        .tab-view { width: 100%; height: 100%; position: absolute; display: none; }
        .tab-view.active { display: block; }
        
        /* 読み込みアニメーション */
        iframe { width: 100%; height: 100%; border: none; opacity: 0; transition: opacity 0.4s ease; }
        iframe.ready { opacity: 1; }
        
        .loader { position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: transparent; z-index: 20; }
        .progress { width: 0%; height: 100%; background: var(--accent); transition: width 0.3s; }

        /* ホーム画面 */
        .home { position: absolute; inset: 0; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; }
        .btn { border: 1px solid #ddd; background: white; padding: 8px 15px; border-radius: 15px; cursor: pointer; }
    </style>
</head>
<body>
<div class="browser">
    <div class="loader"><div id="pBar" class="progress"></div></div>
    <div class="tab-bar" id="tabBar">
        <span class="add-btn" onclick="addTab()">+</span>
    </div>
    <div class="toolbar">
        <div style="display:flex; gap:10px;">
            <button onclick="nav('back')" style="border:none;background:none;cursor:pointer;font-size:18px;">←</button>
            <button onclick="nav('reload')" style="border:none;background:none;cursor:pointer;font-size:18px;">↻</button>
        </div>
        <input type="text" id="addr" class="address-bar" placeholder="URLを入力 (google.com など)" onkeydown="if(event.key==='Enter') load()">
    </div>
    <div class="viewport-container" id="vp"></div>
</div>

<script>
    let tabs = [];
    let activeId = null;

    function addTab() {
        const id = 'ifr_' + Date.now();
        const tab = document.createElement('button');
        tab.className = 'tab';
        tab.id = 't_' + id;
        tab.innerHTML = `<span>New Tab</span><span class="close" onclick="closeTab('${id}', event)">×</span>`;
        tab.onclick = () => switchTab(id);
        document.getElementById('tabBar').insertBefore(tab, document.querySelector('.add-btn'));

        const view = document.createElement('div');
        view.className = 'tab-view';
        view.id = 'v_' + id;
        view.innerHTML = `
            <div class="home" id="h_${id}">
                <h2>Cloud Browser Pro</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn" onclick="quick('google.com')">Google</button>
                    <button class="btn" onclick="quick('wikipedia.org')">Wikipedia</button>
                </div>
            </div>
            <iframe id="${id}" onload="done('${id}')"></iframe>
        `;
        document.getElementById('vp').appendChild(view);
        tabs.push(id);
        switchTab(id);
    }

    function switchTab(id) {
        activeId = id;
        document.querySelectorAll('.tab, .tab-view').forEach(el => el.classList.remove('active'));
        document.getElementById('t_'+id).classList.add('active');
        document.getElementById('v_'+id).classList.add('active');
        
        const currentUrl = document.getElementById(id).getAttribute('data-url');
        document.getElementById('addr').value = currentUrl || '';
    }

    function load() {
        let url = document.getElementById('addr').value;
        if (!url) return;
        if (!url.startsWith('http')) url = 'https://' + url;

        document.getElementById('h_' + activeId).style.display = 'none';
        document.getElementById('pBar').style.width = '70%';
        
        const ifr = document.getElementById(activeId);
        ifr.classList.remove('ready');
        ifr.setAttribute('data-url', url);
        
        // Base64難読化して送信
        const b64 = btoa(unescape(encodeURIComponent(url)));
        ifr.src = '/proxy?b64url=' + b64;
    }

    function done(id) {
        if (id === activeId) document.getElementById('pBar').style.width = '100%';
        setTimeout(() => {
            if (id === activeId) document.getElementById('pBar').style.width = '0%';
            document.getElementById(id).classList.add('ready');
        }, 300);
        const url = document.getElementById(id).getAttribute('data-url');
        if (url) document.getElementById('t_'+id).querySelector('span').innerText = url.split('/')[2];
    }

    function quick(u) { document.getElementById('addr').value = u; load(); }
    function nav(type) {
        const ifr = document.getElementById(activeId);
        if(type === 'back') ifr.contentWindow.history.back();
        if(type === 'reload') load();
    }
    function closeTab(id, e) {
        e.stopPropagation();
        document.getElementById('t_'+id).remove();
        document.getElementById('v_'+id).remove();
        tabs = tabs.filter(t => t !== id);
        if(tabs.length > 0) switchTab(tabs[tabs.length-1]);
    }

    addTab();
</script>
</body>
</html>
